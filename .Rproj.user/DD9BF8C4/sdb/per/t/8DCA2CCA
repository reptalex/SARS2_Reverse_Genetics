{
    "collab_server" : "",
    "contents" : "library(ape)\nlibrary(picante)\nlibrary(data.table)\nlibrary(ggplot2)\nlibrary(magrittr)\nlibrary(rentrez)\nlibrary(DECIPHER)\nlibrary(patchwork)\nlibrary(ggpubr)\nlibrary(muscle)\nlibrary(msa)\nlibrary(seqinr)\nlibrary(ggtree)\nlibrary(xlsx)\nlibrary(phytools)\nsource('scripts/utils.R')\ntheme_set(theme_bw(base_size=15))\nload('data/spike_alignment_workspace2.Rd')\n\n\n# mapping tree tip-labels to accession numbers ----------------------------\n\nCoV_Legend$Accession <- CoV_Legend$NCBI %>% strsplit('\\\\.') %>% sapply(getElement,1) %>% gsub(\"\\\\'\",'',.) %>% gsub(' ','_',.)\n\nBsaI <- lapply(CoV_Legend$Accession,digest_genome,enzymes='BsaI',fragments=FALSE) %>% rbindlist\nBsmBI <- lapply(CoV_Legend$Accession,digest_genome,enzymes='BsmBI',fragments=FALSE) %>% rbindlist\n\nBsSites <- rbind(BsaI,BsmBI)\nBsSites[,rel_position:=position/genome_length]\n\ncv=CoV_Legend\nsetkey(cv,Accession)\nsetkey(BsSites,Accession)\nBsSites=BsSites[cv[,c('Accession','tip.label')]]\n\n\n\n\nBsSites[,tip.label:=factor(tip.label,levels=tree$tip.label)]\n\ng_bs=ggplot(BsSites,aes(tip.label,rel_position))+\n  geom_point(aes(color=Restriction_Enzyme),cex=2)+\n  geom_hline(yintercept = as.numeric(BsSites[grepl('SARS2',tip.label),rel_position]),lty=2)+\n  geom_vline(xintercept = as.numeric(BsSites[grepl('SARS2',tip.label),tip.label]),color='red')+\n  coord_flip()+\n  ggtitle('BsaI/BsmBI Sites: all CoVs')\ng_bs\nggsave('figures/BsaI_BsmBI_sites_all_CoVs.png',height=11,width=8,units='in')\n\n\nbcovs <- tree$tip.label[phangorn::Descendants(tree,76,'tips')[[1]]]\n\nbs_bcovs=BsSites[tip.label %in% setdiff(bcovs,'PCoV-GX')]\nbs_bcovs[,tip.label:=factor(tip.label,levels=rev(levels(tip.label)))]\n\ng_bcovs=ggplot(bs_bcovs,aes(tip.label,rel_position))+\n  geom_point(aes(color=Restriction_Enzyme),cex=3)+\n  geom_vline(xintercept = c(32,33),color='red')+\n  geom_hline(yintercept=bs_bcovs[grepl(\"SARS2\",tip.label)]$rel_position,lty=2)+\n  coord_flip()+\n  ggtitle('BsaI/BsmBI Sites: BetaCoVs')\nggsave('figures/BsaI_BsmBI_sites_BetaCoVs.png',height=8,width=8,units='in')\n\nggplot(bs_bcovs,aes(tip.label,rel_position))+\n  geom_point(aes(color=Restriction_Enzyme),cex=3)+\n  geom_vline(xintercept = c(32,33),color='red')+\n  geom_hline(yintercept=bs_bcovs[grepl(\"SARS2\",tip.label)]$rel_position,lty=2)+\n  coord_flip()+\n  ggtitle('BsaI/BsmBI Sites: BetaCoVs')\n\n# Incorporate tree --------------------------------------------------------\ntree$tip.label\n\ngtr_bcovs=ggtree(keep.tip(tree,setdiff(bcovs,'PCoV-GX')),branch.length = 'none')+geom_tiplab()+\n  ggtitle(\"Betacoronavirus Phylogeny\")+\n  ggplot2::xlim(c(0,17))\n\nlbls=gtr_bcovs$data$label[order(gtr_bcovs$data[gtr_bcovs$data$isTip==TRUE,]$y)]\n\n\nbs_bcovs[,tip:=factor(tip.label,levels=lbls)]\n\ng_bcovs2=ggplot(bs_bcovs,aes(tip,rel_position))+\n  geom_point(aes(color=Restriction_Enzyme),cex=3)+\n  geom_vline(xintercept = c(32,33),color='red')+\n  geom_hline(yintercept=bs_bcovs[grepl(\"SARS2\",tip)]$rel_position,lty=2)+\n  coord_flip()+\n  scale_x_discrete(NULL,labels=NULL)+\n  ggtitle('BsaI/BsmBI Sites: BetaCoVs')+\n  theme(legend.position='bottom')\nggarrange(gtr_bcovs+\n            theme(plot.margin = unit(c(8,30,85,20),'pt')),\n          g_bcovs2+\n            theme(plot.margin= unit(c(0,10,0,0),'pt')))\nggsave('figures/beta_cov_tree_and_BsaI_BsmBI_sites.png',height=10,width=14)\n\nsave(list=ls(),file='data/CoV_phylo_analysis_workspace.Rds')\n\n\n# max-fragment-length phylogram -------------------------------------------\n\n\nMaxBS <- lapply(CoV_Legend$Accession,digest_genome,enzymes=c('BsaI','BsmBI')) %>% rbindlist\nMaxBS$tip.label <- CoV_Legend$tip.label\n\nMaxBS <- MaxBS[tip.label %in% tree$tip.label]\nMaxBS[,rel_size:=max_fragment_length/genome_length]\nMaxBS[,nLLS:=no_fragments*rel_size]\n\nMaxBS[,tip.label:=factor(tip.label,levels=tree$tip.label)]\nrownames(MaxBS) <- as.character(MaxBS$tip.label)\nggplot(MaxBS,aes(tip.label,rel_size*no_fragments))+\n  geom_point(cex=3)+\n  geom_point(data=MaxBS[grepl('SARS2',tip.label)],cex=5,color='red')+\n  scale_y_continuous('Fragment-Corrected LLS')+\n  geom_hline(yintercept = MaxBS[grepl('SARS2',tip.label)]$nLLS,color='red')+\n  coord_flip()+\n  ggtitle('BsaI/BsmBI LLS')\nggsave('figures/BsaI_BsmBI_LLS.png',height=13,width=8,units='in')\n\n\n\n# BglI --------------------------------------------------------------------\n\n### Previous studies of SARS CoVs used BglI. Why not BglI in SARS2?\n\n\nBglI <- lapply(CoV_Legend$Accession,digest_genome,enzymes='BglI',fragments=FALSE) %>% rbindlist\n\nBglI[,rel_position:=position/genome_length]\n\n\nsetkey(BglI,Accession)\nBglI=BglI[cv[,c('Accession','tip.label')]]\n\n\nBglI[,tip.label:=factor(tip.label,levels=tree$tip.label)]\n\n### Need to add lines showing SARS2 and CoVs for which BglI was used.\n\n# pBAC-SARS-CoVFL\n# SARS-CoV\n# Bat-SCoV\n# MERS-CoV\n# SARS-CoV Urban\n# SL-CoV WIV1\nrcovs=c('WIV1','MERS-HCoV','SARS1-Urbani','SARS1')\n\n\nBglI[tip.label=='WIV1',backbone:='WIV1']\nBglI[grepl('SARS1',tip.label),backbone:='SARS1']\nBglI[grepl('MERS',tip.label),backbone:='MERS']\nBglI[grepl('SARS2',tip.label),backbone:='SARS2']\nBglI[is.na(backbone),backbone:='other']\nBglI[,backbone:=factor(backbone,levels=c('SARS1','MERS','WIV1','SARS2','other'))]\n\n\ncls =gg_color_hue(3)\nggplot(BglI,aes(tip.label,rel_position))+\n  geom_point(aes(color=backbone,fill=backbone,pch=backbone,size=backbone))+\n  coord_flip()+\n  ggtitle('BglI Sites: all CoVs')+\n  scale_color_manual(values=c(rep('black',4),'darkgrey'))+\n  scale_fill_manual(values=c(cls,'red',NA))+\n  scale_shape_manual(values=c(21,21,21,21,16))+\n  scale_size_manual(values=c(4,4,4,4,2))\nggsave('figures/CoV_BglI_sites.png',height=13,width=7)\n",
    "created" : 1664650401479.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2650764937",
    "id" : "8DCA2CCA",
    "lastKnownWriteTime" : 1665118328,
    "last_content_update" : 1665118328252,
    "path" : "~/COVID/Origins/RestrictionSites/SARS2_Reverse_Genetics/scripts/CoV_phylogenetic_analyses.R",
    "project_path" : "scripts/CoV_phylogenetic_analyses.R",
    "properties" : {
    },
    "relative_order" : 3,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}