{
    "collab_server" : "",
    "contents" : "library(ape)\nlibrary(data.table)\nlibrary(ggplot2)\nlibrary(magrittr)\nlibrary(xlsx)\nlibrary(rentrez)\nlibrary(muscle)\nlibrary(DECIPHER)\nlibrary(ggpubr)\nlibrary(adegenet)\nsource('scripts/utils.R')\ntheme_set(theme_bw(base_size=15))\nCoV_Legend <- read.csv('data/CoV_genome_to_tree_legend.csv') %>% as.data.table\n\n# Load genomes ------------------------------------------------------------\n\n\nfilepath=paste0('data/fasta_files/genome_accn_',CoV_Legend[tip.label=='SARS2-WHu1',Accession],'[accn].fasta')\nSARS2=read.FASTA(filepath) %>%\n  as.character %>% lapply(.,paste0,collapse=\"\") %>% unlist %>% DNAStringSet\n\nfilepath=paste0('data/fasta_files/genome_accn_',CoV_Legend[tip.label=='RaTG13',Accession],'[accn].fasta')\nRaTG13=read.FASTA(filepath) %>%\n  as.character %>% lapply(.,paste0,collapse=\"\") %>% unlist %>% DNAStringSet\n\nfilepath=paste0('data/fasta_files/genome_accn_',CoV_Legend[tip.label=='BANAL-52',Accession],'[accn].fasta')\nBANAL52=read.FASTA(filepath) %>%\n  as.character %>% lapply(.,paste0,collapse=\"\") %>% unlist %>% DNAStringSet\n\n\nSEQs <- c(SARS2,RaTG13,BANAL52)\n\n# Align genomes -----------------------------------------------------------\n\nmusc <- muscle(SEQs)\n\nX <- as.DNAbin(musc)\n\nMutations <- findMutations(X)\nnames(Mutations)\n\n# [1] \"NC_045512.2 Severe acute respiratory syndrome coronavirus 2 isolate Wuhan-Hu-1, complete genome->MN996532.2 Bat coronavirus RaTG13, complete genome\"                       \n# [2] \"NC_045512.2 Severe acute respiratory syndrome coronavirus 2 isolate Wuhan-Hu-1, complete genome->MZ937000.1 Bat coronavirus isolate BANAL-20-52/Laos/2020, complete genome\"\n# [3] \"MN996532.2 Bat coronavirus RaTG13, complete genome->NC_045512.2 Severe acute respiratory syndrome coronavirus 2 isolate Wuhan-Hu-1, complete genome\"                       \n# [4] \"MN996532.2 Bat coronavirus RaTG13, complete genome->MZ937000.1 Bat coronavirus isolate BANAL-20-52/Laos/2020, complete genome\"                                             \n# [5] \"MZ937000.1 Bat coronavirus isolate BANAL-20-52/Laos/2020, complete genome->NC_045512.2 Severe acute respiratory syndrome coronavirus 2 isolate Wuhan-Hu-1, complete genome\"\n# [6] \"MZ937000.1 Bat coronavirus isolate BANAL-20-52/Laos/2020, complete genome->MN996532.2 Bat coronavirus RaTG13, complete genome\"  \n\nDists <- lapply(Mutations[c(3,5)],getElement,'short') %>% sapply(length)\n\n##1135 mutations RaTG13-->SARS2\n## 903 mutations BANAL52-->SARS2\n\nsave(list=ls(),file='data/close_relative_alignments.Rds')\n\n# Mutations -------------------------------------------------------\ncls <- viridis::viridis(3)\nRaTsites <- Mutations[[3]]$short %>% strsplit(':') %>% sapply(getElement,1) %>% as.numeric\nBANALsites <- Mutations[[5]]$short %>% strsplit(':') %>% sapply(getElement,1) %>% as.numeric\n\ndata('RESTRICTION_ENZYMES')\nR <- RESTRICTION_ENZYMES\n\nbsai <- R['BsaI']\nbsmbi <- R['BsmBI']\nbgli <- R['BglI']\n\nSARS_RES <- rbind(digest_genome(\"NC_045512\",enzymes = 'BsaI',fragments=F),\n                  digest_genome(\"NC_045512\",enzymes = 'BsmBI',fragments=F),\n                  digest_genome(\"NC_045512\",enzymes = 'BglI',fragments=F))\n\nSARS_RES <- digest_genome(SEQ=SARS2)\nRAT_RES <- digest_genome(SEQ=RaTG13)\nBAN_RES <- digest_genome(SEQ=BANAL52)\n\nRES <- rbind(SARS_RES,RAT_RES,BAN_RES)\nRES[,max_fragment_length:=max_fragment_length/genome_length]\nRES$virus <- c('SARS-CoV-2','RaTG13','BANAL52')\nprobs=base.freq(X)\n\n# Mutation Analysis -------------------------------------------------------\n### Takes a long time\n# MUT_RaTG13 <- mutate_digest(RaTG13,mutations=Dists[1],reps=1e5,ncores = 7)\n# MUT_RaTG13$virus <- 'RaTG13'\n# MUT_RaTG13[,max_fragment_length:=max_fragment_length/genome_length]\n# MUT_BANAL52 <- mutate_digest(BANAL52,mutations=Dists[2],reps=1e5,ncores = 7)\n# MUT_BANAL52$virus <- 'BANAL52'\n# MUT_BANAL52[,max_fragment_length:=max_fragment_length/genome_length]\n# save(list=ls(),file='data/mutation_analysis_workspace.Rds')\n\nload('data/mutation_analysis_workspace.Rds')\n\n# Plotting ----------------------------------------------------------------\nload('data/restriction_digest_workspace.Rds')\nSARS_RES$virus <- 'SARS-CoV-2'\nSARS_RES[,max_fragment_length:=max_fragment_length/genome_length]\nMUT <- rbind(SARS_RES[,c('max_fragment_length','no_fragments','virus')],\n             MUT_BANAL52[,c('max_fragment_length','no_fragments','virus')],\n             MUT_RaTG13[,c('max_fragment_length','no_fragments','virus')])\n\ng_mut=ggplot(all_max_frags[no_fragments<=12 & !grepl('SARS2',tip.label)],\n            aes(factor(no_fragments),max_fragment_length))+\n  geom_boxplot(lwd=2,col='darkgrey')+\n  scale_x_discrete('Number of Fragments')+\n  scale_y_continuous('Length of Longest Fragment')+\n  geom_jitter(data=MUT[virus!='SARS-CoV-2' & no_fragments<=12],\n              aes(color=virus),cex=0.3,alpha=0.2)+\n  geom_point(data=RES,aes(color=virus),cex=6)+\n  geom_point(data=RES,cex=6,pch=21)+\n  scale_color_manual(values=c('darkolivegreen','darkorchid1','red'))+\n  theme(legend.position=c(.8,.8))+\n  ggtitle('Assembly of Mutants')\ng_mut\nggsave('figures/mutation_analysis.png',height=10,width=15)\n\n\n\n# dZ ----------------------------------------------------------------------\n\nref=all_max_frags[no_fragments<=12,list(mn=mean(max_fragment_length),\n                    sd=sd(max_fragment_length)),by=no_fragments]\n\n\nsetkey(ref,no_fragments)\nsetkey(MUT,no_fragments)\nY=ref[MUT]\n\nY[,z:=(mn-max_fragment_length)/sd]\n\nsetkey(RES,no_fragments)\nyy=ref[RES]\nyy[,initial_z:=(mn-max_fragment_length)/sd]\nsetkey(yy,virus)\nsetkey(Y,virus)\nY=Y[yy[,c('virus','initial_z')]]\n\nY[,dz:=z-initial_z]\n\ndum<- data.table('virus'=c('RaTG13','BANAL52'))\ndum$dz <- yy[match(dum$virus,virus)]$z-yy[virus=='SARS-CoV-2']$initial_z\n\ng_dz=ggplot(Y[virus!='SARS-CoV-2'],aes(dz))+\n  geom_histogram(aes(fill=virus),position='identity')+\n  facet_wrap(.~virus,nrow=2)+\n  geom_vline(data=dum,aes(xintercept=dz),color='red',lwd=2)+\n  scale_fill_manual(values=c('darkolivegreen','darkorchid1'))+\n  theme(legend.position='none')\n\nggarrange(g_mut,g_dz,widths=c(2,1),align='h',labels=c('A','B'))\nggsave('figures/mutation_analysis_and_dz.png',height=8,width=16)\n\n\n\n# Statistics --------------------------------------------------------------\n\nsars_2_z <- 1.5338862\n### What is the probability of seeing no_fragments in the desired range AND z>=sars_2_z?\n\npvals=Y[virus!='SARS-CoV-2',list(P=sum(no_fragments>=5 & no_fragments<=7 & z>=sars_2_z)/.N),by=virus]\n#      virus       P\n# 1: BANAL52 0.00150\n# 2:  RaTG13 0.01154\n\n\nall_max_frags[,sticky_end_length:=sticky_ends(Restriction_Enzyme),by=Restriction_Enzyme]\n\n### How many CoVs can be made as infectious clones?\n\nall_max_frags[,z:=(mean(max_fragment_length)-max_fragment_length)/sd(max_fragment_length),by=no_fragments]\n\nall_max_frags[sticky_end_length>=3 & no_fragments>=5 & no_fragments<=7][order(z,decreasing = T)][1:5]\n#        tip.label Restriction_Enzyme max_fragment_length no_fragments genome_length sticky_end_length        z\n# 1: Bat-Alpha-CoV        GGTCTC(1/5)           0.2961106            5         28128                 4 1.403368\n# 2:  Bat-CoV-unid      GCGATG(10/14)           0.2716825            6         28975                 4 1.373955\n# 3:         HKU17        GGTCTC(1/5)           0.2369743            7         26083                 4 1.364690\n# 4:     HKU12-600      GCGATG(10/14)           0.3134945            5         26396                 4 1.272347\n# 5:          HKU8      GCGATG(10/14)           0.2872832            6         28773                 4 1.237337\n\n# \n# g_hist <- all_max_frags[sticky_end_length>=3 & !grepl('SARS2',tip.label) & (no_fragments<5 | no_fragments>7)] %>%\n#   ggplot(aes(no_fragments))+\n#   geom_histogram(fill=rgb(0,0,0,0.3),col='darkgrey',bins=93)+\n#   geom_histogram(data=all_max_frags[sticky_end_length>=3 &\n#                                       !grepl('SARS2',tip.label) &\n#                                       no_fragments>=5 & \n#                                       no_fragments<=7],\n#                  color='steelblue',fill='steelblue',bins=93)+\n#   geom_vline(xintercept = 6,lwd=2,col='red')+\n#   scale_y_continuous('Count')+\n#   annotate(geom='segment',x=6,y=72,xend=50,yend=60,color='red',lwd=2)+\n#   annotate(geom='text',x=60,y=60,label='SARS-COV-2',color='red',size=12)+\n#   annotate(geom='segment',x=7,y=60,xend=50,yend=48,color='steelblue',lwd=2)+\n#   annotate(geom='text',x=62.8,y=48,label='Ideal RGS Range',color='steelblue',size=12)+\n#   scale_x_continuous('Number of Fragments')+\n#   ggtitle('SARS-CoV-2 BsaI/BsmBI in ideal range for RGS')\n# \n# \n# ggarrange(g_mut,ggarrange(g_dz,g_hist,nrow=2,heights=c(2,1)),widths=c(2,1))\n# ggsave('figures/mutation_analysis_fig_3.png',height=8,width=12)",
    "created" : 1665269403966.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1246561777",
    "id" : "9AFB69B6",
    "lastKnownWriteTime" : 1665271155,
    "last_content_update" : 1665271155679,
    "path" : "~/COVID/Origins/RestrictionSites/SARS2_Reverse_Genetics/scripts/5_mutation_analysis.R",
    "project_path" : "scripts/5_mutation_analysis.R",
    "properties" : {
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}