{
    "collab_server" : "",
    "contents" : "library(ape)\nlibrary(data.table)\nlibrary(ggplot2)\nlibrary(magrittr)\nlibrary(rentrez)\nlibrary(DECIPHER)\nlibrary(muscle)\nlibrary(msa)\nlibrary(seqinr)\nlibrary(ggtree)\nlibrary(xlsx)\nsource('scripts/utils.R')\n\n\n##### Sequences from external analysis\nseqs <- read.xlsx('data/genbank4 - Spike ORFs.xlsx',sheetIndex = 1) %>% as.data.table\nseqs$gene <- gsub('/','_',seqs$gene)\ncolnames(seqs)[c(1,2,4,5)] <- c('Species','Accession','start','stop')\nseqs$Accession <- gsub(' ','',seqs$Accession)\n\n\n# Get list of coronavirus genomes --------------------------------------------\n\n\n\nGenomeSeqs <- referenceSeqs() %>% as.data.table\nGenomeSeqs[,gene_accn:=Accession]\nGenomeSeqs$Accession <- strsplit(GenomeSeqs$gene_accn,'\\\\.') %>% sapply(getElement,1) \n\n\nSeqs <- rbind(seqs[,c('Species','Accession','start','stop')],\n              GenomeSeqs[!Accession %in% seqs$Accession,c('Species','Accession','start','stop')])\n\n# Load genomes & write to .fasta file -----------------------------------------------\n\n\ngenome_accns= paste0(Seqs$Accession,'[accn]')\n\nSeqs$genome_available='Yes'\nfor (i in 1:length(genome_accns)){\n  accs <- rentrez::entrez_search('nucleotide',\n                                 term=genome_accns[i])\n  if (length(accs$ids)!=0){\n    rentrez::entrez_search('genome',\n                           term=genome_accns[i])\n    genome=entrez_fetch(db=\"nucleotide\", id=accs$ids, rettype=\"fasta\")\n    write(genome,file=paste0('data/fasta_files/genome_accn_',genome_accns[i],'.fasta'))\n  } else {\n    Seqs$genome_available[i] <- \"No\"\n  }\n}\n\nsaveRDS(Seqs,file='data/CoV_Genome_Sequences.Rds')\n\n# Collect Spike genes -----------------------------------------------------\n\n# Seqs <- readRDS('data/CoV_Genome_Sequences.Rds')\n\nix <- which(Seqs$genome_available=='Yes')\n\nSpikes <- NULL\nSpikeAAs <- NULL\nfor (i in ix){\n  filepath=paste0('data/fasta_files/genome_accn_',genome_accns[i],'.fasta')\n  \n  SEQ=read.FASTA(filepath) %>%\n    as.character %>% lapply(.,paste0,collapse=\"\") %>% unlist %>% DNAStringSet\n  \n  orf <- nearest_orf(SEQ,Seqs$start[i],Seqs$stop[i])\n  \n  spike <- subseq(SEQ,start = orf['start'], end=orf['stop']+2)\n  if (is.null(Spikes)){\n    Spikes <- spike\n  } else {\n    Spikes <- c(Spikes,spike)\n  }\n  \n  spike_AA=Biostrings::translate(spike,if.fuzzy.codon = 'solve')\n  if (is.null(SpikeAAs)){\n    SpikeAAs <- spike_AA\n  } else {\n    SpikeAAs <- c(SpikeAAs,spike_AA)\n  }\n}\n\n\nsave(list=ls(),file='data/spike_alignment_workspace1.Rd')\n\n\n\n# Align Spike AAs ---------------------------------------------------------\n\nload(file='data/spike_alignment_workspace1.Rd')\n\n\nfor (i in 1:length(SpikeAAs)){\n  if (i==1){\n    write.fasta(SpikeAAs[i],file = 'data/fasta_files/spike_aas.fasta',names=names(SpikeAAs)[i])\n  } else {\n    write.fasta(SpikeAAs[i],file = 'data/fasta_files/spike_aas.fasta',names=names(SpikeAAs)[i],open = 'a')\n  }\n}\n\n\n# phylogenetic analysis ---------------------------------------------------\n\n### Phylogeny was constructed in MEGA on the clustal alignment of AA sequences saved above\n\ntree <- read.tree('data/CoV_ML_phylogeny_from_clustal_AA_alignment.nwk')\n\n\nggtree(tree,layout='radial')+geom_tiplab()\n\n############### Cleaning Phylogeny ###################\n### the tree reveals a few erroneous sequences also evident in the muscle alignment in R.\n### Below, we process the tree to remove these erroneous tips.\n\nerroneous_tips <- c(\"'NC 003045.1 Bovine coronavirus isolate BCoV-ENT complete genome(3)'\",\n                    \"'NC 003045.1 Bovine coronavirus isolate BCoV-ENT complete genome(2)'\",\n                    \"MZ937003.2_Bat_coronavirus_isolate_BANAL-20-236/Laos/2020_complete_genome\",\n                    \"'NC 010437.1 Bat coronavirus 1A complete genome(2)'\")\ntree <- drop.tip(tree,erroneous_tips)\n\n\n# Now, the tip labels are long & inelegant for plotting. Need to make a mapping from \n# NCBI names to names for our paper.\n\nCoV_Legend=rbind(c(\"NC_045512.2_Severe_acute_respiratory_syndrome_coronavirus_2_isolate_Wuhan-Hu-1_complete_genome\",'SARS2-WHu1'),\n                c(\"MN996528.1_Severe_acute_respiratory_syndrome_coronavirus_2_isolate_WIV04_complete_genome\",'SARS2-WIV04'),\n                c(\"MT040333.1_Pangolin_coronavirus_isolate_PCoV_GX-P4L_complete_genome\",'PCoV-GX'),\n                c(\"MN996532.2_Bat_coronavirus_RaTG13_complete_genome\",'RaTG13'),\n                c(\"MZ937000.1_Bat_coronavirus_isolate_BANAL-20-52/Laos/2020_complete_genome\",'BANAL-52'),\n                c(\"MZ937001.1_Bat_coronavirus_isolate_BANAL-20-103/Laos/2020_complete_genome\",'BANAL-103'),\n                c(\"MT121216.1_Pangolin_coronavirus_isolate_MP789_complete_genome\",'PCoV_MP789'),\n                c(\"MG772933.1_Bat_SARS-like_coronavirus_isolate_bat-SL-CoVZC45_complete_genome\",'Sl-CoVZC45'),\n                c(\"MG772934.1_Bat_SARS-like_coronavirus_isolate_bat-SL-CoVZXC21_complete_genome\",'Sl-CoVZXC21'),\n                c(\"MZ937002.1_Bat_coronavirus_isolate_BANAL-20-116/Laos/2020_complete_genome\",'BANAL-116'),\n                c(\"MZ937004.1_Bat_coronavirus_isolate_BANAL-20-247/Laos/2020_complete_genome\",'BANAL-247'),\n                c(\"GQ153543.1_Bat_SARS_coronavirus_HKU3-8_complete_genome\",'HKU3'),\n                c(\"NC_014470.1_Bat_coronavirus_BM48-31/BGR/2008_complete_genome\",'BM48'),\n                c(\"KF367457.1_Bat_SARS-like_coronavirus_WIV1_complete_genome\",'WIV1'),\n                c(\"KC881005.1_Bat_SARS-like_coronavirus_RsSHC014_complete_genome\",'RsSHC014'),\n                c(\"KT444582.1_SARS-like_coronavirus_WIV16_complete_genome\",'WIV16'),\n                c(\"AY278741.1_SARS_coronavirus_Urbani_complete_genome\",'SARS1-Urbani'),\n                c(\"AY274119.3_SARS_coronavirus_Tor2_complete_genome\",'SARS1-Tor2-1'),\n                c(\"NC_004718.3_SARS_coronavirus_Tor2_complete_genome\",'SARS1-Tor2-2'),\n                c(\"NC_025217.1_Bat_Hp-betacoronavirus/Zhejiang2013_complete_genome\",'Bat-Hp-BCov'),\n                c(\"NC_009021.1_Rousettus_bat_coronavirus_HKU9_complete_genome\",'HKU9'),\n                c(\"NC_030886.1_Rousettus_bat_coronavirus_isolate_GCCDC1_356_complete_genome\",'GCCDC1'),\n                c(\"NC_048212.1_Bat_coronavirus_complete_genome\",'Bat-CoV-unid'),\n                c(\"NC_001846.1_Murine_hepatitis_virus_strain_MHV-A59_C12_mutant_complete_genome\",'MHV-A59-C122'),\n                c(\"NC_048217.1_Murine_hepatitis_virus_strain_A59_complete_genome\",'MHV-A59-2'),\n                c(\"NC_012936.1_Rat_coronavirus_Parker_complete_genome\",'Rat-CoV-Parker'),                                                                                                                               \n                c(\"NC_006577.2_Human_coronavirus_HKU1_complete_genome\",'HKU1'),                                                                                                                               \n                c(\"NC_026011.1_Betacoronavirus_HKU24_strain_HKU24-R05005I_complete_genome\",'HKU24'),                                                                                                          \n                c(\"NC_046954.1_Rodent_coronavirus_isolate_RtMruf-CoV-2/JL2014_complete_genome\",'RtMruf-CoV-2'),                                                                                                       \n                c(\"NC_017083.1_Rabbit_coronavirus_HKU14_complete_genome\",'HKU14'),                                                                                                                             \n                c(\"AY391777.1_Human_coronavirus_OC43_complete_genome\",'Human-CoV-O43'),                                                                                                                            \n                c(\"NC_006213.1_Human_coronavirus_OC43_strain_ATCC_VR-759_complete_genome\",'Human-CoV-OC43-ATTC'),                                                                                                            \n                c(\"NC_003045.1_Bovine_coronavirus_isolate_BCoV-ENT_complete_genome\",'BCoV-ENT'),                                                                                                                 \n                c(\"'NC 003045.1 Bovine coronavirus isolate BCoV-ENT complete genome(4)'\",'BCoV-ENT-4'),                                                                                                           \n                c(\"NC_009020.1_Pipistrellus_bat_coronavirus_HKU5_complete_genome\",'HKU5'),                                                                                                                    \n                c(\"NC_009019.1_Tylonycteris_bat_coronavirus_HKU4_complete_genome\",'HKU4'),                                                                                                                   \n                c(\"NC_034440.1_Bat_coronavirus_isolate_PREDICT/PDF-2180_complete_genome\",'Bat-CoV-PREDICT-2180'),                                                                                                             \n                c(\"NC_039207.1_Betacoronavirus_Erinaceus/VMC/DEU/2012_isolate_ErinaceusCoV/2012-174/GER/2012_complete_genome\",'ErinaceusCoV'),                                                                        \n                c(\"JX869059.2_Human_betacoronavirus_2c_EMC/2012_complete_genome\",'Human-BetaCoV-2c'),                                                                                                                     \n                c(\"NC_019843.3_Middle_East_respiratory_syndrome-related_coronavirus_isolate_HCoV-EMC/2012_complete_genome\",'MERS-HCoV'),                                                                         \n                c(\"NC_038294.1_Betacoronavirus_England_1_isolate_H123990006_complete_genome\",'BetaCoV-England-1'),                                                                                                        \n                c(\"NC_032730.1_Lucheng_Rn_rat_coronavirus_isolate_Lucheng-19_complete_genome\",'Rat-CoV-Lucheng'),                                                                                                       \n                c(\"NC_009988.1_Rhinolophus_bat_coronavirus_HKU2_complete_genome\",'HKU2'),                                                                                                                    \n                c(\"NC_048211.1_Wencheng_Sm_shrew_coronavirus_isolate_Xingguo-74_ORF1ab_polyprotein_spike_glycoprotein_envelope_protein_membrane_protein_and_nucleocapsid_protein_genes_complete_cds\",'Shrew-CoV-Xingguo-74'), \n                c(\"NC_035191.1_Wencheng_Sm_shrew_coronavirus_isolate_Xingguo-101_ORF1ab_polyprotein_spike_glycoprotein_envelope_protein_membrane_protein_and_nucleocapsid_protein_genes_complete_cds\",'Shrew-CoV-Xingguo-101'),\n                c(\"NC_010800.1_Turkey_coronavirus_complete_genome\",'Turkey-CoV'),                                                                                                                                   \n                c(\"NC_048214.1_Duck_coronavirus_isolate_DK/GD/27/2014_complete_genome\",'Duck-CoV'),                                                                                                           \n                c(\"NC_048213.1_Infectious_bronchitis_virus_isolate_Ind-TN92-03_complete_genome\",'Ind-TN92-03'),                                                                                                      \n                c(\"NC_016995.1_Wigeon_coronavirus_HKU20_complete_genome\",'HKU20'),                                                                                                                             \n                c(\"NC_011547.1_Bulbul_coronavirus_HKU11-934_complete_genome\",'HKU11-934'),                                                                                                                         \n                c(\"NC_039208.1_Porcine_coronavirus_HKU15_strain_HKU15-155_complete_genome\",'HKU15-155'),                                                                                                          \n                c(\"NC_011550.1_Munia_coronavirus_HKU13-3514_complete_genome\",'HKU13-3514'),                                                                                                                        \n                c(\"NC_016991.1_White-eye_coronavirus_HKU16_complete_genome\",'HKU16'),                                                                                                                          \n                c(\"NC_016996.1_Common_moorhen_coronavirus_HKU21_complete_genome\",'HKU21'),                                                                                                                     \n                c(\"NC_011549.1_Thrush_coronavirus_HKU12-600_complete_genome\",'HKU12-600'),                                                                                                                         \n                c(\"NC_016993.1_Magpie-robin_coronavirus_HKU18_complete_genome\",'HKU18'),                                                                                                                      \n                c(\"NC_016992.1_Sparrow_coronavirus_HKU17_complete_genome\",'HKU17'),                                                                                                                            \n                c(\"NC_016994.1_Night-heron_coronavirus_HKU19_complete_genome\",'HKU19'),                                                                                                                  \n                c(\"NC_046964.1_Alphacoronavirus_Bat-CoV/P.kuhlii/Italy/3398-19/2015_complete_genome\",'Bat-Alpha-CoV'),                                                                                                 \n                c(\"NC_010437.1_Bat_coronavirus_1A_complete_genome\",'Bat-CoV-1A'),                                                                                                                                   \n                c(\"NC_010438.1_Miniopterus_bat_coronavirus_HKU8_complete_genome\",'HKU8'),                                                                                                                     \n                c(\"NC_002645.1_Human_coronavirus_229E_complete_genome\",'229E'),                                                                                                                               \n                c(\"NC_028752.1_Camel_alphacoronavirus_isolate_camel/Riyadh/Ry141/2015_complete_genome\",'Camel-Alpha-CoV'),                                                                                               \n                c(\"JX504050.1_Human_coronavirus_NL63_isolate_NL63/RPTEC/2004_complete_genome\",'Human-CoV-NL63'),                                                                                                        \n                c(\"NC_048216.1_NL63-related_bat_coronavirus_strain_BtKYNL63-9b_complete_genome\",'Bat-CoV-9b'),                                                                                                      \n                c(\"NC_032107.1_NL63-related_bat_coronavirus_strain_BtKYNL63-9a_complete_genome\",'Bat-CoV-9a'),                                                                                                      \n                c(\"NC_009657.1_Scotophilus_bat_coronavirus_512_complete_genome\",'Bat-CoV-512'),                                                                                                                      \n                c(\"MK841495.1_Porcine_epidemic_diarrhea_virus_isolate_PEDV_YZ_complete_genome\",'Porcine-CoV-PEDV'),                                                                                                      \n                c(\"NC_022103.1_Bat_coronavirus_CDPHE15/USA/2006_complete_genome\",'Bat-CoV-CDPHE15'),                                                                                                                   \n                c(\"NC_030292.1_Ferret_coronavirus_isolate_FRCoV-NL-2010_complete_genome\",'FRCoV-NL-2010'),                                                                                                             \n                c(\"NC_002306.3_Feline_infectious_peritonitis_virus_complete_genome\",'Feline-CoV'),                                                                                                                  \n                c(\"DQ811788.1_TGEV_Purdue_P115_complete_genome\",'TGEV-Purdue-P115'),                                                                                                                                     \n                c(\"NC_038861.1_Transmissible_gastroenteritis_virus_complete_genome_genomic_RNA\",'Gastro-CoV')) %>%\n            as.data.table\nnames(CoV_Legend) <- c('NCBI','tip.label')\n\nall.equal(tree$tip.label,CoV_Legend$NCBI)\ntree$tip.label <- CoV_Legend$tip.label\n\n\nggtree(tree)+\n  geom_tiplab()+\n  ggplot2::xlim(c(0,2))\n\nwrite.tree(tree,file='data/CoV_phylogeny_neat_tiplabs.nwk')\n\nsave(list=ls(),file='data/spike_alignment_workspace2.Rd')\n",
    "created" : 1664650292769.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "278311792",
    "id" : "D76F990D",
    "lastKnownWriteTime" : 1664660623,
    "last_content_update" : 1664660623812,
    "path" : "~/COVID/Origins/RestrictionSites/SARS2_Reverse_Genetics/scripts/CoV_phylogenetic_inference.R",
    "project_path" : "scripts/CoV_phylogenetic_inference.R",
    "properties" : {
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}